---
title: "Friday meeting single cell analysis"
---

```{r,include=FALSE}
library(CATALYST)
library(flowCore)
library(cowplot) 
library(ggplot2)
library(dplyr)
library(diffcyt)
library(tidyverse)
library(ggridges)
```


### Set up SCE
```{r}
# Read a file from the dataset
pathtosamples <- "Data"
frame <- read.FCS(list.files(path=pathtosamples,pattern='.fcs',full.names=TRUE)[[1]]) 
write.csv2(x = pData(parameters(frame))[,2], file = "panel_FM.csv") # Have a look at all the channels names and numbers

FuncInds <- c(36,	37,	39,	42,	44,	51,	52,	56,	57,	61) # Functional markers
ToUse <- c(7,	15,	16,	18,	19, 31,	33,	34,	40,	41,	43,	46,	49,	58,	60,	71) # Clustering/DR

# Check
pData(parameters(frame))[,2][FuncInds] 
pData(parameters(frame))[,2][ToUse] 

# Make the panel
signaling <- pData(parameters(frame))[FuncInds,1:3]
signaling$range <- "state" 
phenotyping <- pData(parameters(frame))[ToUse,1:3]
phenotyping$range <- "type" 
panel <- rbind(signaling, phenotyping)
rownames(panel) <- NULL
colnames(panel) <- c("fcs_colname", "antigen","marker_class")
panel

meta <- read.csv2("meta_FMair.csv") # Read meta from file.
meta$sample_id <- sample_id <- paste0(meta$Stim, "_",meta$condition)
meta
```


### Read inn the data using the panel and metadata
```{r, message=FALSE,warning=FALSE}
# Subsampling 
set.seed(0) # Being reproducible is a plus
sampling.ceiling <- 10000

fullframe <- read.flowSet(meta$filename, transformation = FALSE, truncate_max_range = FALSE)
fsApply(fullframe, nrow)
fs.ds <- fsApply(fullframe, function(ff) {
  idx <- sample.int(nrow(ff), min(sampling.ceiling, nrow(ff)))
  ff[idx,]  # alt. ff[order(idx),]
})
fsApply (fs.ds, nrow)

sce = prepData(fs.ds, panel, meta, md_cols = list(factors = colnames(meta)))
sce
fs.ds <- NULL
fullframe <- NULL
```


### Show the number of cells in each sample
```{r}
plotCounts(sce, 
    group_by = "patient_id", 
    color_by = "Stim")
```


### Use FlowSOM to cluster data
```{r}
## FlowSOM
ptm <- proc.time()
sce <- cluster(sce, features = "type",
               xdim = 10, ydim = 10, maxK = 30,
               verbose = FALSE, seed = 1)
proc.time() - ptm

# UMAP
ptm <- proc.time()
set.seed(1601)
sce <- runDR(sce, dr = "UMAP", cells = 10000, features = "type") # cells is per sample!
proc.time() - ptm # How long does it take? Elapsed is in seconds

# Save the data for late use
saveRDS(sce, file ="sceFM.RData")
```


### If you are reading the SCE from Rdata
```{r}
sce <- readRDS("sceFM.RData")
```


### Make som plot to help in cluster merging and annotation
```{r}
testparams <- c("meta10", "meta20")

p <- plotDR(sce, color_by = type_markers(sce))
p$facet$params$ncol <- 4
p <- p+theme_cowplot()
ggsave(filename = paste0("TypemarkersUMAP", ".jpeg",sep=""),width =300,
       height = 300,
       units = "mm")
p

for (i in 1:length(testparams)){
  print(testparams[i])
  # Cluster UMAP
  p <- plotDR(sce, color_by = testparams[i])
  p <- p+theme_cowplot()
  ggsave(filename = paste0("clusterUMAP",testparams[i], ".jpeg",sep=""),
       p, width = 320,
       height = 300,
       units = "mm")

  # Heatmaps
  p <- plotExprHeatmap(sce, features = "type",
    by = "cluster_id", k = testparams[i],
    scale = "last", q = 0.01,bars = TRUE, perc = TRUE, col_dend = TRUE)
  p@matrix_param[["gp"]][["col"]] <- NA
  name <- paste0("heatmap_last_",testparams[i], ".pdf",sep="")
  
  pdf(file = name)
  print(p)
  dev.off()

  p <- plotExprHeatmap(sce, features = "type",
    by = "cluster_id", k = testparams[i],
    scale = "never",hm_pal = hcl.colors(10, "Inferno"), bars = TRUE, perc = TRUE, col_dend = TRUE)
  p@matrix_param[["gp"]][["col"]] <- NA
  p@matrix_color_mapping@levels <- c(0,1,2,3,4)
  name <- paste0("heatmap_first_",testparams[i], ".pdf",sep="")
  
  pdf(file = name)
  print(p)
  dev.off()
  
  p <- ggplot(na.omit(data.frame(as.data.frame(reducedDim(sce, "UMAP")), "ClusterID" = cluster_ids(sce, k = testparams[i])), 
               cols = 1)) + 
  geom_point(aes(x=V1, y=V2, color=ClusterID)) + 
  facet_wrap(vars(ClusterID)) + 
  theme_cowplot()
  ggsave(file = paste0("ClusterloopUMAP",testparams[i], ".jpeg",sep=""), width =300, 
       height = 300, 
       units = "mm")
  p
  
    # Boxplots
  p <- plotAbundances(sce, k = testparams[i], by = "cluster_id", 
    group_by = "Stim", shape_by = "condition")
  p <- p+theme_cowplot()
  ggsave(filename = paste0("Boxplots_",testparams[i], ".jpeg",sep=""))
}
```


### Print heatmap to make table for cluster annotation and merging
```{r}
# Print out the medians for each cluster
p <- plotExprHeatmap(sce, features = "type",
    by = "cluster_id", k = "meta10",
    scale ="never", q = 0.01,bars = TRUE, perc = TRUE, col_dend = TRUE)

write.csv(as.data.frame(p@matrix), file = paste0("heatmap_noscaled", ".csv",sep=""))
```


### Merge and annotate
```{r}
cluster_merge <- read.csv("merging_table.csv", sep=";") # Needs exactly columnames : old_cluster and new_cluster
head(cluster_merge)
sce <- mergeClusters(sce, k = "meta10", table = cluster_merge, id = "merged", overwrite = TRUE)
head(cluster_codes(sce))

# Save the annotated data for late use
saveRDS(sce, file ="annotatedsceFM.RData")
```


# Evaluate the proportions of cell types in patient samples
```{r}
testparams <- c("merged")

p <- plotDR(sce, color_by = testparams)
p <- p+theme_cowplot()
ggsave(filename = paste0("annotated_clusterUMAP",testparams, ".pdf",sep=""), device = "pdf",
       p, width = 10,
       height = 7)

p <- plotDR(sce, color_by = testparams, facet_by = "patient_id")
p <- p+theme_cowplot()
ggsave(filename = paste0("annotated_clusterPatUMAP",testparams, ".pdf",sep=""), device = "pdf",p, width = 12, height = 7)

p <- plotDR(sce, color_by = testparams, facet_by = "condition")
p <- p+theme_cowplot()
ggsave(filename = paste0("annotated_clusterConUMAP",testparams, ".pdf",sep=""), device = "pdf",p, width = 10, height = 4)

# Heatmaps
p <- plotExprHeatmap(sce, features = "type",
                     by = "cluster_id", k = testparams,
                     scale = "last", q = 0.01,bars = TRUE, perc = TRUE, col_dend = TRUE)
p@matrix_param[["gp"]][["col"]] <- NA
name <- paste0("annotated_heatmap_last_",testparams, ".pdf",sep="")
  
pdf(file = name, width = 8, height = 5)
print(p)
dev.off()

p <- plotExprHeatmap(sce, features = "type",
                     by = "cluster_id", k = testparams,
                     scale = "never",hm_pal = hcl.colors(10, "Inferno"), 
                     bars = TRUE, perc = TRUE, col_dend = TRUE)
p@matrix_param[["gp"]][["col"]] <- NA
p@matrix_color_mapping@levels <- c(0,1,2,3,4)
name <- paste0("annotated_heatmap_never_",testparams, ".pdf",sep="")
  
pdf(file = name,width = 8, height = 5)
print(p)
dev.off()

  
p <- plotAbundances(sce, k = testparams, by = "sample_id", group_by = "patient_id")
ggsave(p,filename = paste0("annotated_columnplot",testparams, ".pdf",sep=""), device = "pdf",
       width = 4,
       height = 8)

  # Boxplots
p <- plotAbundances(sce, k = testparams, by = "cluster_id", group_by = "Stim", shape_by = "condition")
  p <- p+theme_cowplot()
  ggsave(filename = paste0("annotatedBoxplots_", testparams, ".jpeg",sep=""))

```


### Abundance and State difference testing
```{r}
u <- sce
testparams <- "merged"

unique(u$Stim)

# create design & constrast matrix
design <- createDesignMatrix(ei(u), cols_design = "Stim")
contrast <- createContrast(c(0, 1))

# Test for differential abundance (DA) of clusters and differential states (DS) within clusters
res_DA <- diffcyt(u, 
                  clustering_to_use = testparams,
                  analysis_type = "DA", 
                  method_DA = "diffcyt-DA-edgeR",
                  design = design, 
                  contrast = contrast, 
                  verbose = FALSE)
tbl_DA <- rowData(res_DA$res)

pdf(file = paste0("Abund_edgeR",testparams, ".pdf",sep=""),
    width = 11.7, # The width of the plot in inches
    height = 16.5)
plotDiffHeatmap(u, tbl_DA, all = TRUE, fdr = 0.1, 
    sort_by = "lfc", col_anno = "Stim", normalize =TRUE)
dev.off()

plotDiffHeatmap(u, tbl_DA,all = TRUE, fdr = 0.1, 
    sort_by = "lfc", col_anno = "Stim", normalize =TRUE)

res_DA <- NULL
tbl_DA<- NULL

res_DA <- diffcyt(u, 
                  clustering_to_use = testparams,
                  analysis_type = "DA", 
                  method_DA = "diffcyt-DA-voom",
                  design = design, 
                  contrast = contrast, 
                  verbose = FALSE)
tbl_DA <- rowData(res_DA$res)

pdf(file = paste0("Abund_Voom",testparams, ".pdf",sep=""),
   width = 11.7, # The width of the plot in inches
    height = 16.5)
plotDiffHeatmap(u, tbl_DA,all = TRUE, fdr = 0.1, 
    sort_by = "lfc", col_anno = "Stim", normalize =TRUE)
dev.off()

plotDiffHeatmap(u, tbl_DA,all = TRUE, fdr = 0.1, 
    sort_by = "lfc", col_anno = "Stim", normalize =TRUE)

res_DA <- NULL
tbl_DA<- NULL

res_DS <- diffcyt(u, 
                  clustering_to_use = testparams,
                  analysis_type = "DS", 
                  method_DS = "diffcyt-DS-limma",
                  design = design, 
                  contrast = contrast, 
                  verbose = FALSE)
tbl_DS <- rowData(res_DS$res)
nosign <- length(tbl_DS$ID[tbl_DS$p_adj<=0.1])

pdf(file = paste0("Signal_limma",testparams, ".pdf",sep=""),
    width = 11, # The width of the plot in inches
    height = 8)
plotDiffHeatmap(u, tbl_DS, all = TRUE, top_n = 12, fdr = 0.1, 
    sort_by = "padj", col_anno = "Stim", normalize =TRUE)
dev.off()

plotDiffHeatmap(u, tbl_DS, all = TRUE, top_n = 12, fdr = 0.1, 
    sort_by = "padj", col_anno = "Stim", normalize =TRUE)

```


### Get data on each cluster in each sample
```{r}
metaclust <- testparams

# Get percentile values for all channels 
scdf <- data.frame(t(assay(sce, "exprs")[state_markers(sce), ]), 
                   sample_id = sce$sample_id, 
                   cluster_id = (dplyr::select(cluster_codes(sce), metaclust))[sce$cluster_id,], 
                   check.names = FALSE)

#scdf[,1:10] <- sinh(scdf[,1:10])*5 # detransform the data

percentiles <- function(dat) {
  ninetiethperc <- stack(lapply(dat, quantile, prob = 0.75, names = FALSE)) #prob = percentile
  return(ninetiethperc)
}

df <- group_by(scdf, sample_id, cluster_id) %>% nest()
df <- df %>% 
  mutate(resultat = map(data, percentiles))

ClusterData <- unnest(df, resultat)
ClusterData$data <- NULL
colnames(ClusterData) <- c("sample_id","cluster_id","value","variable")

# Get percent cluster frequencies 
n_cells <- table(sce$sample_id, cluster_ids(sce, k = metaclust))
props <- as.data.frame(prop.table(n_cells, margin = 1))
props$variable <- "PercentFreq"
colnames(props) <- c("sample_id","cluster_id","value","variable")

# Rbind together into a single frame, and add some variables
ClusterData <- rbind(ClusterData,props)
ClusterData$sample_id <- as.character(ClusterData$sample_id)

s <- ClusterData$sample_id[1]
#"time"       "trial"      "staining"   "patient" 

get_Stim <- function(s) {
  get_Stim <-  strsplit(s, "_")[[1]][1]
  return(get_Stim)
}

get_con <- function(s) {
  con <-  paste0(strsplit(s, "_")[[1]][2])
  return(con)
}

ClusterData <- ClusterData %>% rowwise() %>% mutate(get_Stim = get_Stim(sample_id), 
                                                    condition = get_con(sample_id))

colnames(ClusterData) <- c("sample_id", "population", "DC_75th", "protein", "Stim", "condition")
write_csv(ClusterData, file = paste0("Clusterdata",metaclust, ".csv",sep=""))
```


## Make some nice plots of the patient data
```{r}
colnames(ClusterData)
#ClusterData2 <- ClusterData %>% filter((population == "Baso"))  

testparams <- unique(ClusterData$protein)

for (i in 1:length(testparams)){
  print(testparams[i])
  ClusterData2 <- ClusterData %>% filter((protein == testparams[i]))
  
  p <- ggplot(ClusterData2, aes(x = sample_id, y = DC_75th, color = population)) +
  geom_point(size = 3) +
  geom_line(aes(group = population),size=1.5) +
  facet_wrap(~ population)
  p <- p+theme_cowplot()
  
  ggsave(p, filename = paste0("raw_data75th", testparams[i], ".pdf"),
       width = 297,
       height = 420, 
       units = "mm")
}
```

### Density patient umaps
```{r}
testparams <- c("merged")

p <- plotDR(sce, color_by = testparams, facet_by = "Stim")

q <- p$data

p <- ggplot(q, aes(x, y)) + 
    stat_density_2d(aes(fill=..level..), geom="polygon",bins=8) +
  scale_fill_gradientn(colours = c("black","darkorchid", "darkgoldenrod1"), values = scales::rescale()) + 
  facet_wrap(q$sample_id, nrow = 1) +
  theme_cowplot()
p

ggsave(p, filename = "Densitypatienumap.pdf", device = "pdf",
       width = 20,
       height = 4)
```


### Historgam Overlays
```{r}
u <- filterSCE(sce, k = "merged")

metaclust <- "merged"

scdf <- data.frame(t(assay(u, "exprs")[state_markers(u), ]), 
                   sample_id = u$sample_id, 
                   cluster_id = (dplyr::select(cluster_codes(u), metaclust))[u$cluster_id,], 
                   check.names = FALSE)
scdf$sample_id <- as.character(scdf$sample_id)
s <- scdf$sample_id[1]
#"time"       "trial"      "staining"   "patient" 

get_Stim <- function(s) {
  get_Stim <-  strsplit(s, "_")[[1]][1]
  return(get_Stim)
}

get_con <- function(s) {
  con <-  paste0(strsplit(s, "_")[[1]][2])
  return(con)
}


scdf <- scdf %>% rowwise() %>% mutate(patient = get_Stim(sample_id), 
                                                    condition = get_con(sample_id))

scdf2 <- rbind(scdf %>% filter((cluster_id == "Monocytes")), scdf %>% filter((cluster_id == "TcEMRA/NKT")))

e<-ggplot(scdf2, aes(x=`pSTAT3_Y705`, y=`sample_id`, color=`sample_id`, fill = `sample_id`)) + 
  geom_density_ridges() +theme_cowplot() + facet_wrap(~cluster_id )
ggsave(e,filename = paste0("PB_IFNa_pSTAT3_Y705.pdf"), width = 7, height = 7)

e<-ggplot(scdf2, aes(x=`pSTAT1_Y701`, y=`sample_id`, color=`sample_id`, fill = `sample_id`)) + 
  geom_density_ridges() +theme_cowplot() + facet_wrap(~cluster_id )
ggsave(e,filename = paste0("PB_IFNa_pSTAT1_Y701.pdf"), width = 7, height = 7)

```
